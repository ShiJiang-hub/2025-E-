
# 2025年电子设计竞赛-简易自行瞄准装置
获得该题目国一

## 项目概述
本项目为2025年全国大学生电子设计竞赛【E题简易自行瞄准装置】的完整实现方案，包含硬件设计、软件代码、调试文档等全部核心内容。
基于MSPM0系列和STM32H7系列微控制器实现了一种高精度的简易自行瞄准装置，由自动寻迹小车和二维云台激光瞄准模块组成。MSPM0G3507控制的小车通过六路红外传感器完成轨迹巡线；STM32H750同步控制云台，结合IMU姿态反馈实现反自旋，根据全局位置估计与PID控制实现动态瞄准。在基本要求中，小车可循迹绕赛道任意圈，平均每圈时间在20秒内；静止状态打靶可在2秒内使激光击中靶心（误差≤1.5cm），云台随机朝向状态打靶可在4秒内完成瞄准（误差≤1.8cm）。在发挥部分中，小车可行驶2圈同时连续瞄准靶心，激光光斑与靶心最大误差≤8cm。本设计的创新点在于融合IMU姿态稳定与运动学补偿算法，显著提升了小车在循迹过程中云台的动态瞄准精度。

## 一、硬件清单
| 模块类型     | 具体型号/规格                                 | 备注               |
|-------------|----------------------------------------------|--------------------|
| 主控芯片     | STM32H750+MSPM0G3507+树莓派B3+ESP32S3LDC触摸屏| 核心控制单元        |
| 电机驱动模块 | AT8236H桥驱动板 + 张大头步进电机F103驱动板x2    | 驱动直流电机+云台步进|
| 执行机构     | 直流减速电机（MG513XL）x2 + 张大头步进电机x2    |  小车四轮驱动       |
| 传感器       | 红外循迹模块（6路）+ 亚博USB免驱动摄像头        | 环境感知            |
| 电源         | 12V锂电池（2000mAh）+5V降压模块               | 供电                |
| 其他配件     | 小车底盘/编码器/ESP01s若干（组网通信）          | 测速/无线控制       |

## 二、软件环境
- 开发工具：Clion（STM32，ESP32S3） / vscode+platformio（ESP01s） / CCS（MSPM0G3507）
- 依赖库：
  - STM32：HAL库
  - ESP32S3：ESPIDF
  - ESP01s：arduino

## 三、代码结构

## 四、核心功能说明
### 1. 循迹功能
- 采用6路红外传感器采集地面黑白线信号；
- 归一化+权重和处理出偏移量数据；
- 通过偏移量数据，结合循迹PID算法调整左右电机转速，实现自动循迹；

### 2. 锁定功能
- 树莓派挂载摄像头；
- 通过仿射变换+参数调整得出靶心和摄像头中心距离
- 输入系数抵消靶心距离和激光笔中心距离
- STM32H750接收该距离，通过云台PID锁定，Can通讯控制步进电机驱动器，进而控制步进电机变换角度，实现锁定靶心。

### 3. 全局补偿算法
- **补偿算法1：**小车行进过程中全程记录编码器的数值，<u>处理出行进距离和速度</u>，速度用于速度环控制小车恒速，行进距离用于构建全局坐标系，理想情况下，在一条直线上行驶，不依赖云台pid，通过计算得出云台所需要的角度和行驶在线上的距离之间的函数表达式，**对该函数求导**，得出云台的角速度；
- **补偿算法2：**小车拐弯时，陀螺仪同步有一个角速度，此时对云台输入一个反向的角速度，就能实现小陀螺算法，即旋转小车，云台保持方向不变。（陀螺仪和云台的周期不同，导致角速度不同，预处理系数解决）；

### 4.中控台调参
- ESP32S3LCD屏幕+LVGL设计中控台页面；
- 拥有PID远程调参页面，支持同时修改双环PID的六个参数；**大幅提高**PID调参效率，比赛过程中**3分钟完成一个PID环的参数整定**。
- 拥有指令页面，可操作小车进行循迹或打靶；

### 5.无线调试
- ESPNow组网：中控台+小车挂载ESP01s+树莓派挂载ESP01s；
- 树莓派将激光笔中心和摄像头中心距离发送至串口，ESP01s接收串口信息，发送至小车的ESP01s用于云台锁定以及中控台用于参数调试；
- 中控台将参数/指令发送至小车ESP01s用于参数整定；
- 所有ESP的数据发送至另外一块ESP01s（以下简称电脑ESP01s），电脑ESP01s通过USB转TTL插入电脑，选择某一台设备后，可以观察该设备的参数信息；
- ESPNow协议运行在MAC层，省去了上层协议转换所需要的实现，具体延时在1ms以内，在传输小型参数数据的延时，稳定性以及性能上远超UDP协议；

## 五、使用步骤
### 1. 硬件接线（CubeMx+CCS需按实际修改，这里不给出）

### 2. 代码烧录

### 3. 调试注意事项
- 先接电源再烧录代码，避免传感器误触发；
- 红外传感器需提前校准：vofa+查看数据，电脑ESP01s选择小车ESP01s通道观察原始数据，将小车在跑道引导线上垂直移动，利用vofa+的波形图，将每个通道的最低值和最大值写入数组，用于归一化；
- PID参数调试：先用中控台调循迹保证小车正常运动，接着让小车静止，调云台锁定靶心。最后一起联调，有补偿算法的作用下，云台pid不需要太过激进。

## 六、演示效果
- 循迹测试：小车可稳定循迹宽度≥2cm的黑色引导线，无明显偏移；
- 锁定测试：随机把摄像头摆放在某个位置，能在4s内找到靶子，并指向靶心；
- 视频链接：[小车运行演示](https://b23.tv/6O1KHSb)

## 七、常见问题解决
1. 电机不转：检查电源接线/驱动模块使能端（ENA）是否拉高；
2. 无法循迹：重新校准红外传感器阈值/输出偏移量数据到电脑ESP01s观察数据正确与否；


## 八、免责声明
本项目仅用于电子设计竞赛学习交流，请勿用于商业用途；硬件接线需严格按照说明，避免短路损坏模块。
